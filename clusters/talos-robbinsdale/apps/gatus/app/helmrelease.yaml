---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gatus
spec:
  interval: 30m
  chart:
    spec:
      chart: gatus
      version: "*"
      sourceRef:
        kind: HelmRepository
        name: twin
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    image:
      tag: latest
    envFrom:
      - secretRef:
          name: gatus
      # - secretRef:
      #     name: gatus-postgres-app
    config:
      #storage:
        #type: postgres
        #path: "$${uri}"
      alerting:
        discord:
          webhook-url: "$${discord-webhook-url}"
          failure-threshold: 3
          success-threshold: 2
      ui:
        title: "K8s Robbinsdale Status"
        description: "GitOps-managed Kubernetes cluster monitoring - Single source of truth for infrastructure health"
        header: "K8s-Robbinsdale Infrastructure Dashboard"
        logo: "https://raw.githubusercontent.com/kubernetes/kubernetes/master/logo/logo.png"
        link: "https://github.com/rajsinghtech/kubernetes-manifests"
        buttons:
          - name: "GitOps Repository"
            link: "https://github.com/rajsinghtech/kubernetes-manifests"
          - name: "Portfolio"
            link: "https://www.rajsingh.info"
      endpoints:
        - name: Silver
          group: servers
          url: tcp://silver.local:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Kubernetes API
          group: kubernetes
          url: https://k8s.robbinsdale.local:6443/readyz
          interval: 60s
          client:
            insecure: true
          conditions:
            - "[STATUS] == 401"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Tank
          group: servers
          url: tcp://tank.local:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Titan
          group: servers
          url: tcp://titan.local:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Stone
          group: servers
          url: tcp://stone.local:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Ubiquiti UNAS Pro
          group: servers
          url: https://nas.local
          interval: 60s
          client:
            insecure: true
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Portfolio - Raj Singh
          group: website
          url: https://www.rajsingh.info
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Immich
          group: home
          url: http://immich-server.immich:2283/api/server/ping
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Cloudflared Tunnel
          group: network
          url: https://status.rajsingh.info
          client:
            dns-resolver: "tcp://1.1.1.1:53"
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Envoy
          group: network
          url: https://status.rajsingh.info
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Portfolio - Luke Houge
          group: website
          url: https://www.${CLUSTER_DOMAIN}
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Jellyfin
          group: media
          url: http://jellyfin.media:8096/health
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Jellystat
          group: media
          url: http://jellystat.media:3000
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Jellyseerr
          group: media
          url: http://jellyseerr.media:5055
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: PiHole Home DNS
          group: network
          url: "ts-pihole-dns.home"
          dns:
            query-name: "google.com"
            query-type: "A"
          conditions:
            - "[DNS_RCODE] == NOERROR"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Frigate
          group: home
          url: https://frigate.${CLUSTER_DOMAIN}
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Homeassistant
          group: home
          url: https://homeassistant.${CLUSTER_DOMAIN}
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true 