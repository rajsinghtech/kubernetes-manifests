---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: liqo
spec:
  interval: 30m
  chart:
    spec:
      chart: liqo
      version: v1.0.1
      sourceRef:
        kind: HelmRepository
        name: liqo
        namespace: flux-system
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    # Cluster identification
    discovery:
      config:
        clusterName: ${LOCATION}
        clusterLabels:
          topology.kubernetes.io/region: ${LOCATION}
          liqo.io/provider: tailscale

    # Networking configuration
    networking:
      internal: true
      # Use Tailscale for connectivity - expose gateway via Tailscale LB
      gatewayTemplates:
        server:
          service:
            type: LoadBalancer
            loadBalancerClass: tailscale
            annotations:
              tailscale.com/hostname: ${LOCATION}-liqo-gateway
              tailscale.com/proxy-class: common

    # API server endpoint via Tailscale
    apiServer:
      address: https://${LOCATION}-k8s-operator.keiretsu.ts.net
      trustedCA: false

    # IPAM configuration
    ipam:
      # Pod CIDR varies per cluster, use variable substitution
      podCIDR: ${CLUSTER_POD_CIDR}
      serviceCIDR: ${CLUSTER_SERVICE_CIDR}
      # Reserved subnets to avoid conflicts with existing networks
      reservedSubnets:
        # Robbinsdale
        - 10.0.0.0/16
        - 10.1.0.0/16
        # Ottawa
        - 10.2.0.0/16
        - 10.3.0.0/16
        # St. Petersburg
        - 10.4.0.0/16
        - 10.5.0.0/16
        # Local LANs
        - 192.168.50.0/24
        - 192.168.169.0/24
        - 192.168.73.0/24

    # Controller manager settings
    controllerManager:
      config:
        # Enable resource sharing
        enableResourceEnforcement: false

    # Metrics for Prometheus
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true

    # Cilium compatibility - tell Cilium to ignore Liqo nodes
    # This is handled by node affinity in Cilium config
