---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: claude-cluster-monitor
spec:
  schedule: "*/15 * * * *"  # Run every 15 minutes
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: claude-cluster-monitor
        spec:
          serviceAccountName: claude-monitor
          restartPolicy: OnFailure
          initContainers:
          # Install Claude Code in an init container
          - name: install-claude
            image: alpine:latest
            command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Installing Claude Code..."
              apk add --no-cache curl bash

              # Download and install Claude Code
              ARCH=$(uname -m)
              if [ "$ARCH" = "x86_64" ]; then
                ARCH="x64"
              elif [ "$ARCH" = "aarch64" ]; then
                ARCH="arm64"
              fi

              curl -fsSL https://storage.googleapis.com/anthropic-release/claude-code/latest/linux-${ARCH}/claude -o /shared/claude
              chmod +x /shared/claude

              echo "Claude Code installed successfully"
            volumeMounts:
            - name: shared
              mountPath: /shared
          containers:
          - name: analyzer
            image: bitnami/kubectl:latest
            command: ["/bin/bash"]
            args:
            - /scripts/analyze-cluster.sh
            env:
            - name: ANTHROPIC_BASE_URL
              value: "http://llm-proxy.keiretsu.ts.net"
            - name: ANTHROPIC_AUTH_TOKEN
              value: "sk-na"
            - name: API_TIMEOUT_MS
              value: "3000000"
            - name: CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC
              value: "1"
            - name: PATH
              value: "/shared:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
            - name: CLUSTER_NAME
              value: "${CLUSTER_NAME}"
            - name: LOCATION
              value: "${LOCATION}"
            volumeMounts:
            - name: scripts
              mountPath: /scripts
              readOnly: true
            - name: shared
              mountPath: /shared
            resources:
              requests:
                memory: "512Mi"
                cpu: "500m"
              limits:
                memory: "2Gi"
                cpu: "2000m"
          volumes:
          - name: scripts
            configMap:
              name: claude-monitor-script
              defaultMode: 0755
          - name: shared
            emptyDir: {}
