---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: headlamp
spec:
  interval: 1m
  chart:
    spec:
      chart: headlamp
      version: "*"
      sourceRef:
        kind: HelmRepository
        name: headlamp
        namespace: flux-system
      interval: 1m
  releaseName: headlamp
  values:
    config:
      # oidc:
      #   clientID: "05c250fc-4dc0-4f53-9381-ab0b704c918e"
      #   clientSecret: "eLHTrBgsWJZhtgWSGwmOppseSRkUDCie"
      #   issuerURL: "https://pocket-id.${CLUSTER_DOMAIN}"
      #   scopes: "openid profile email"
      inCluster: false

    volumeMounts:
      - name: kubeconfig
        mountPath: /kubeconfig
        readOnly: true
      - mountPath: /headlamp/plugins
        name: headlamp-plugins

    volumes:
      - name: kubeconfig
        secret:
          secretName: headlamp-kubeconfig
          defaultMode: 0444
      - name: headlamp-plugins
        emptyDir: {}

    env:
      - name: KUBECONFIG
        value: /kubeconfig/config
    initContainers:
      - name: flux-plugin
        command:
          - /bin/sh
          - -c
          - mkdir -p /headlamp/plugins && cp -r /plugins/* /headlamp/plugins/
        image: ghcr.io/headlamp-k8s/headlamp-plugin-flux:latest
        imagePullPolicy: Always
        volumeMounts:
          - mountPath: /headlamp/plugins
            name: headlamp-plugins

      - name: cert-manager-plugin
        command:
          - /bin/sh
          - -c
          - mkdir -p /headlamp/plugins && cp -r /plugins/* /headlamp/plugins/
        image: ghcr.io/headlamp-k8s/headlamp-plugin-cert-manager:latest
        imagePullPolicy: Always
        volumeMounts:
          - mountPath: /headlamp/plugins
            name: headlamp-plugins

      - name: ai-assistant-plugin
        command:
          - /bin/sh
          - -c
          - mkdir -p /headlamp/plugins && cp -r /plugins/* /headlamp/plugins/
        image: ghcr.io/headlamp-k8s/headlamp-plugin-ai-assistant:latest
        imagePullPolicy: Always
        volumeMounts:
          - mountPath: /headlamp/plugins
            name: headlamp-plugins

      - name: opencost-plugin
        command:
          - /bin/sh
          - -c
          - mkdir -p /headlamp/plugins && cp -r /plugins/* /headlamp/plugins/
        image: ghcr.io/headlamp-k8s/headlamp-plugin-opencost:latest
        imagePullPolicy: Always
        volumeMounts:
          - mountPath: /headlamp/plugins
            name: headlamp-plugins

      - name: keda-plugin
        command:
          - /bin/sh
          - -c
          - mkdir -p /headlamp/plugins && cp -r /plugins/* /headlamp/plugins/
        image: ghcr.io/headlamp-k8s/headlamp-plugin-keda:latest
        imagePullPolicy: Always
        volumeMounts:
          - mountPath: /headlamp/plugins
            name: headlamp-plugins

      - name: kompose-plugin
        command:
          - /bin/sh
          - -c
          - mkdir -p /headlamp/plugins && cp -r /plugins/* /headlamp/plugins/
        image: ghcr.io/headlamp-k8s/headlamp-plugin-kompose:latest
        imagePullPolicy: Always
        volumeMounts:
          - mountPath: /headlamp/plugins
            name: headlamp-plugins

      - name: plugin-catalog-plugin
        command:
          - /bin/sh
          - -c
          - mkdir -p /headlamp/plugins && cp -r /plugins/* /headlamp/plugins/
        image: ghcr.io/headlamp-k8s/headlamp-plugin-plugin-catalog:latest
        imagePullPolicy: Always
        volumeMounts:
          - mountPath: /headlamp/plugins
            name: headlamp-plugins

      - name: backstage-plugin
        command:
          - /bin/sh
          - -c
          - mkdir -p /headlamp/plugins && cp -r /plugins/* /headlamp/plugins/
        image: ghcr.io/headlamp-k8s/headlamp-plugin-backstage:latest
        imagePullPolicy: Always
        volumeMounts:
          - mountPath: /headlamp/plugins
            name: headlamp-plugins

      - name: app-catalog-plugin
        command:
          - /bin/sh
          - -c
          - mkdir -p /headlamp/plugins && cp -r /plugins/* /headlamp/plugins/
        image: ghcr.io/headlamp-k8s/headlamp-plugin-app-catalog:latest
        imagePullPolicy: Always
        volumeMounts:
          - mountPath: /headlamp/plugins
            name: headlamp-plugins