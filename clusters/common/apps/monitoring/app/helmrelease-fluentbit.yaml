---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: fluent-bit
spec:
  interval: 5m
  chart:
    spec:
      chart: fluent-bit
      version: "0.30.4"
      sourceRef:
        kind: HelmRepository
        name: fluent
        namespace: flux-system
  values:
    image:
      repository: fluent/fluent-bit # use image from dockerhub
    fullnameOverride: fluent-bit
    testFramework:
      enabled: false
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "2020"
      prometheus.io/path: /api/v1/metrics/prometheus
      fluentbit.io/exclude: "true"
    config:
      service: |
        [SERVICE]
            Daemon Off
            Flush {{ .Values.flush }}
            Log_Level {{ .Values.logLevel }}
            Parsers_File parsers.conf
            Parsers_File custom_parsers.conf
            HTTP_Server On
            HTTP_Listen 0.0.0.0
            HTTP_Port {{ .Values.metricsPort }}
            Health_Check On

      inputs: |
        [INPUT]
            Name tail
            Path /var/log/containers/*.log
            multiline.parser docker, cri
            Tag kube.*
            Mem_Buf_Limit 5MB
            Skip_Long_Lines On

      filters: |
        [FILTER]
            Name kubernetes
            Match kube.*
            Merge_Log On
            Keep_Log Off
            K8S-Logging.Parser On
            K8S-Logging.Exclude On

        [FILTER]
            Name grep
            Match kube.*
            Regex $kubernetes['container_name'] ^envoy$

        [FILTER]
            Name parser
            Match kube.*
            Key_Name log
            Parser envoy
            Reserve_Data True

      outputs: |
        [OUTPUT]
            Name                   loki
            Match                  kube.*
            Host                   loki.monitoring.svc.cluster.local
            Port                   3100
            Labels                 job=fluentbit, app=$kubernetes['labels']['app'], k8s_namespace_name=$kubernetes['namespace_name'], k8s_pod_name=$kubernetes['pod_name'], k8s_container_name=$kubernetes['container_name'] 