---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: coder
  namespace: coder
spec:
  interval: 30m
  chart:
    spec:
      chart: coder
      version: 2.29.0
      sourceRef:
        kind: HelmRepository
        name: coder
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    coder:
      env:
        # Database configuration
        - name: CODER_PG_CONNECTION_URL
          valueFrom:
            secretKeyRef:
              name: coder-db-url
              key: url

        # Access URLs
        - name: CODER_ACCESS_URL
          value: "https://coder.${CLUSTER_DOMAIN}"
        - name: CODER_WILDCARD_ACCESS_URL
          value: "*.coder.${CLUSTER_DOMAIN}"

        # OIDC Authentication with Pocket ID
        - name: CODER_OIDC_ISSUER_URL
          value: "https://pocket-id.${CLUSTER_DOMAIN}"
        - name: CODER_OIDC_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: coder-oidc
              key: client-id
        - name: CODER_OIDC_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: coder-oidc
              key: client-secret
        - name: CODER_OIDC_EMAIL_DOMAIN
          value: ""
        - name: CODER_OIDC_SCOPES
          value: "openid,email,profile"
        - name: CODER_OIDC_SIGN_IN_TEXT
          value: "Sign in with Pocket ID"
        - name: CODER_OIDC_ICON_URL
          value: "https://cdn.jsdelivr.net/gh/homarr-labs/dashboard-icons/svg/pocket-id-light.svg"
        - name: CODER_OIDC_IGNORE_EMAIL_VERIFIED
          value: "true"

        # Disable password authentication (OIDC only)
        - name: CODER_DISABLE_PASSWORD_AUTH
          value: "true"

      service:
        type: ClusterIP
        sessionAffinity: ClientIP

    serviceAccount:
      create: true
      # name: coder
