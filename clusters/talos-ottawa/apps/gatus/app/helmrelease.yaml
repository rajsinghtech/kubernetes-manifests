---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gatus
spec:
  interval: 30m
  chart:
    spec:
      chart: gatus
      version: 1.4.4 # Pinned version from original kustomization
      sourceRef:
        kind: HelmRepository
        name: twin
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    image:
      tag: latest
    # envFrom:
    #   - secretRef:
    #       name: gatus
      # - secretRef:
      #     name: gatus-postgres-app
    config:
      #storage:
        #type: postgres
        #path: "$${uri}"
      alerting:
        discord:
          webhook-url: "${DISCORD_WEBHOOK_URL}"
          failure-threshold: 3
          success-threshold: 2
      ui:
        title: "K8s Ottawa Status"
        description: "GitOps-managed Kubernetes cluster monitoring - Single source of truth for infrastructure health"
        header: "K8s-Ottawa Infrastructure Dashboard"
        logo: "https://raw.githubusercontent.com/kubernetes/kubernetes/master/logo/logo.png"
        link: "https://github.com/keiretsu-labs/kubernetes-manifests"
        buttons:
          - name: "GitOps Repository"
            link: "https://github.com/keiretsu-labs/kubernetes-manifests"
          # - name: "Portfolio"
          #   link: "https://www.${CLUSTER_DOMAIN}"
      endpoints:
        - name: Ottawa (K8s Cluster)
          group: Tailscale
          url: https://ottawa-k8s-operator.keiretsu.ts.net:443/readyz
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Robbinsdale (K8s Cluster)
          group: Tailscale
          url: https://robbinsdale-k8s-operator.keiretsu.ts.net:443/readyz
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Rei (K8s Node)
          group: Servers
          url: tcp://rei.killinit.internal:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Asuka (K8s Node)
          group: Servers
          url: tcp://asuka.killinit.internal:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Kaji (K8s Node)
          group: Servers
          url: tcp://kaji.killinit.internal:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Nagato (NAS)
          group: Servers
          url: tcp://nagato.killinit.internal:445
          interval: 60s
          client:
            insecure: true
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Kubernetes API
          group: Kubernetes
          url: https://k8s.killinit.internal:6443/readyz
          interval: 60s
          client:
            insecure: true
          conditions:
            - "[STATUS] == 401"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Envoy-Public
          group: Networking
          url: https://status.${CLUSTER_DOMAIN}
          interval: 60s
          client:
            dns-resolver: "tcp://1.1.1.1:53"
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Envoy-Tailscale
          group: Networking
          url: https://status.${CLUSTER_DOMAIN}
          interval: 60s
          client:
            dns-resolver: "tcp://ts-pihole-dns.home:53"
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Envoy-Private
          group: Networking
          url: https://status.${CLUSTER_DOMAIN}
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Jellyfin
          group: Media
          url: http://jellyfin.media:8096/health
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Jellystat
          group: Media
          url: http://jellystat.media:3000
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Jellyseerr
          group: Media
          url: http://jellyseerr.media:5055
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true