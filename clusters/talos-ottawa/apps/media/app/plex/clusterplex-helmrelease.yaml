---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: clusterplex
  namespace: media
spec:
  interval: 30m
  chart:
    spec:
      chart: clusterplex
      version: "1.1.10"
      sourceRef:
        kind: HelmRepository
        name: clusterplex
        namespace: flux-system
  maxHistory: 2
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  uninstall:
    keepHistory: false
  values:
    global:
      timezone: ${TIMEZONE}
      sharedStorage:
        transcode:
          storageClass: rook-cephfs
          size: 50Gi
        media:
          existingClaim: media-share

    pms:
      config:
        transcodeOperatingMode: remote
        version: latest
      configVolume:
        size: 10Gi
      resources: {}

    orchestrator:
      config:
        workerSelectionStrategy: LOAD_TASKS
      resources: {}

    worker:
      env:
        - name: VERSION
          value: latest
        - name: FFMPEG_HWACCEL
          value: vaapi
      securityContext:
        privileged: true
      resources:
        requests:
          gpu.intel.com/i915: "10"
        limits:
          gpu.intel.com/i915: "10"