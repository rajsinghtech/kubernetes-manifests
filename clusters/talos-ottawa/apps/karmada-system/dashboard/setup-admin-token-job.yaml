---
# This Job creates a long-lived admin token in the Karmada control plane
# for dashboard authentication. The token never expires.
apiVersion: batch/v1
kind: Job
metadata:
  name: karmada-dashboard-setup-token
  namespace: karmada-system
  annotations:
    # Ensures this runs after the dashboard is installed
    helm.sh/hook-weight: "10"
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: default
      containers:
        - name: setup-token
          image: ghcr.io/fluxcd/flux-cli:v2.7.5
          command:
            - /bin/sh
            - -c
            - |
              set -e

              # Use the dashboard kubeconfig to connect to Karmada API
              export KUBECONFIG=/kubeconfig/kubeconfig

              echo "Creating dashboard-admin ServiceAccount in Karmada..."
              kubectl apply -f - <<'EOF'
              apiVersion: v1
              kind: ServiceAccount
              metadata:
                name: dashboard-admin
                namespace: karmada-system
              EOF

              echo "Creating long-lived token secret..."
              kubectl apply -f - <<'EOF'
              apiVersion: v1
              kind: Secret
              metadata:
                name: dashboard-admin-token
                namespace: karmada-system
                annotations:
                  kubernetes.io/service-account.name: dashboard-admin
              type: kubernetes.io/service-account-token
              EOF

              echo "Creating ClusterRoleBinding..."
              kubectl apply -f - <<'EOF'
              apiVersion: rbac.authorization.k8s.io/v1
              kind: ClusterRoleBinding
              metadata:
                name: dashboard-admin
              roleRef:
                apiGroup: rbac.authorization.k8s.io
                kind: ClusterRole
                name: cluster-admin
              subjects:
                - kind: ServiceAccount
                  name: dashboard-admin
                  namespace: karmada-system
              EOF

              echo "Waiting for token to be populated..."
              sleep 5

              echo ""
              echo "=== DASHBOARD ADMIN TOKEN ==="
              echo "Use this token to login to the Karmada Dashboard:"
              echo ""
              kubectl get secret dashboard-admin-token -n karmada-system -o jsonpath='{.data.token}' | base64 -d
              echo ""
              echo ""
              echo "=== Token stored in secret: dashboard-admin-token ==="
              echo "Retrieve it anytime with:"
              echo "kubectl --kubeconfig <karmada-kubeconfig> get secret dashboard-admin-token -n karmada-system -o jsonpath='{.data.token}' | base64 -d"
              echo ""
          volumeMounts:
            - name: kubeconfig
              mountPath: /kubeconfig
              readOnly: true
      volumes:
        - name: kubeconfig
          secret:
            secretName: karmada-dashboard-kubeconfig
