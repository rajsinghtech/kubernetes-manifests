name: Claude Code Analysis with K8s Access

permissions:
  id-token: write      # Required for OIDC token
  contents: read       # Required for checkout
  pull-requests: write # For PR comments

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      audience:
        description: "Audience for the OIDC token"
        required: true
        default: "api.tailscale.com/kb8cB2pMCZ11CNTRL"
      client_id:
        description: "Client ID for the Tailscale OIDC JWT exchange"
        required: true
        default: "TbqNGJkY5611CNTRL/kb8cB2pMCZ11CNTRL"

jobs:
  analyze-code:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      # Step 1: Get GitHub OIDC token
      - name: Get OIDC token from GitHub Actions
        id: get_oidc_token
        run: |
          AUDIENCE="${{ github.event.inputs.audience || 'api.tailscale.com/kb8cB2pMCZ11CNTRL' }}"
          JWT=$(curl -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${AUDIENCE}" | jq -r '.value')
          echo "::add-mask::$JWT"
          echo "jwt=$JWT" >> $GITHUB_OUTPUT

      # Step 2: Exchange OIDC token for Tailscale access token
      - name: Exchange OIDC token for Tailscale access
        id: get_tailscale_token
        run: |
          CLIENT_ID="${{ github.event.inputs.client_id || 'TbqNGJkY5611CNTRL/kb8cB2pMCZ11CNTRL' }}"
          ACCESS_TOKEN=$(./tailscale/scripts/exchange-oidc-token.sh \
            "${CLIENT_ID}" \
            "${{ steps.get_oidc_token.outputs.jwt }}")
          echo "::add-mask::$ACCESS_TOKEN"
          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT
          echo "Successfully obtained Tailscale access token"

      # Step 3: Install and configure Tailscale
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          tailscale --version

      # Step 4: Create ephemeral auth key and connect to Tailscale
      - name: Create Tailscale auth key
        id: create_authkey
        run: |
          echo "Creating ephemeral auth key..."
          RESPONSE=$(curl -s -X POST \
            https://api.tailscale.com/api/v2/tailnet/-/keys \
            -H "Authorization: Bearer ${{ steps.get_tailscale_token.outputs.access_token }}" \
            -H "Content-Type: application/json" \
            -d '{
              "capabilities": {
                "devices": {
                  "create": {
                    "reusable": false,
                    "ephemeral": true,
                    "preauthorized": true,
                    "tags": ["tag:ci", "tag:claude-agent"]
                  }
                }
              },
              "expirySeconds": 3600
            }')

          AUTH_KEY=$(echo "$RESPONSE" | jq -r '.key')
          if [ "$AUTH_KEY" == "null" ] || [ -z "$AUTH_KEY" ]; then
            echo "Error: Failed to create auth key" >&2
            echo "Response: $RESPONSE" >&2
            exit 1
          fi

          echo "::add-mask::$AUTH_KEY"
          echo "authkey=$AUTH_KEY" >> $GITHUB_OUTPUT
          echo "‚úÖ Auth key created"

      - name: Connect to Tailscale
        run: |
          echo "Starting tailscaled..."
          sudo tailscaled --state=/var/lib/tailscale/tailscaled.state --socket=/run/tailscale/tailscaled.sock &
          sleep 3

          echo "Connecting to Tailscale..."
          sudo tailscale up --authkey="${{ steps.create_authkey.outputs.authkey }}" --hostname="claude-agent-$(date +%s)"

          echo "Verifying Tailscale connection..."
          sudo tailscale status
          echo "‚úÖ Connected to Tailscale"

      # Step 5: Configure kubectl with Tailscale
      - name: Configure kubectl via Tailscale
        run: |
          echo "Configuring kubectl via Tailscale..."
          tailscale configure kubeconfig ottawa-k8s-operator.keiretsu.ts.net

          echo "Verifying kubectl connection..."
          kubectl cluster-info
          kubectl get nodes

          echo "‚úÖ Successfully connected to Kubernetes cluster via Tailscale"

      # Step 6: Setup Node.js and install dependencies
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Agent SDK and dependencies
        run: |
          cd .github/scripts/claude-agent
          npm install
          echo "‚úÖ Dependencies installed"

      # Step 7: Run Claude Code analysis
      - name: Run Claude Code analysis
        env:
          ANTHROPIC_BASE_URL: http://llm-proxy.keiretsu.ts.net
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.LLM_PROXY_API_KEY }}
          API_TIMEOUT_MS: 3000000
          CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC: 1
        run: |
          cd .github/scripts/claude-agent
          node analyze.js
          echo "‚úÖ Analysis complete"

      # Step 8: Display results
      - name: Display results
        run: |
          if [ -f analysis-results.json ]; then
            echo "=== Analysis Results ==="
            cat analysis-results.json | jq '.'
            echo "======================="
          else
            echo "‚ö†Ô∏è  No analysis results file found"
          fi

      # Step 9: Comment on PR with results
      - name: Comment on PR
        if: github.event_name == 'pull_request' && hashFiles('analysis-results.json') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('analysis-results.json', 'utf-8'));

            let body = '## ü§ñ Claude Code Analysis Results\n\n';
            body += `**Summary:** ${results.summary}\n\n`;

            if (results.bugs && results.bugs.length > 0) {
              body += '### üêõ Issues Found\n\n';
              const highSev = results.bugs.filter(b => b.severity === 'high').length;
              const medSev = results.bugs.filter(b => b.severity === 'medium').length;
              const lowSev = results.bugs.filter(b => b.severity === 'low').length;

              body += `**Severity breakdown:** `;
              if (highSev > 0) body += `üî¥ ${highSev} high `;
              if (medSev > 0) body += `üü° ${medSev} medium `;
              if (lowSev > 0) body += `üü¢ ${lowSev} low`;
              body += '\n\n';

              results.bugs.slice(0, 10).forEach(bug => {
                const icon = bug.severity === 'high' ? 'üî¥' : bug.severity === 'medium' ? 'üü°' : 'üü¢';
                body += `${icon} **${bug.severity.toUpperCase()}**: ${bug.description}\n`;
                body += `  - File: \`${bug.file}:${bug.line}\`\n`;
                if (bug.recommendation) {
                  body += `  - Fix: ${bug.recommendation}\n`;
                }
                body += '\n';
              });

              if (results.bugs.length > 10) {
                body += `\n_...and ${results.bugs.length - 10} more issues_\n`;
              }
            } else {
              body += '### ‚úÖ No issues found!\n\n';
            }

            if (results.recommendations && results.recommendations.length > 0) {
              body += '### üí° Recommendations\n\n';
              results.recommendations.forEach(rec => {
                body += `- ${rec}\n`;
              });
              body += '\n';
            }

            if (results.k8s_status) {
              body += '### ‚ò∏Ô∏è Kubernetes Cluster Status\n\n';
              body += `- **Nodes:** ${results.k8s_status.nodes}\n`;
              body += `- **Pods:** ${results.k8s_status.pods}\n`;
              if (results.k8s_status.issues && results.k8s_status.issues.length > 0) {
                body += '\n**Issues detected:**\n';
                results.k8s_status.issues.forEach(issue => {
                  body += `- ${issue}\n`;
                });
              }
            }

            body += '\n---\n';
            body += '_Analysis performed by Claude Code Agent with Kubernetes access via Tailscale_';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      # Step 10: Fail if high-severity issues found
      - name: Check for high-severity issues
        if: always()
        run: |
          if [ -f analysis-results.json ]; then
            HIGH_SEV=$(cat analysis-results.json | jq -r '.bugs[] | select(.severity == "high") | .severity' | wc -l)
            if [ "$HIGH_SEV" -gt 0 ]; then
              echo "‚ùå Found $HIGH_SEV high-severity issues!"
              echo "Please review the analysis results and fix critical issues before merging."
              exit 1
            fi
          fi
          echo "‚úÖ No high-severity issues found"
